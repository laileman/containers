
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: backend-demo-route
  namespace: backend-demo # 保持与后端 Service 同命名空间
spec:
  # 关键修正：指定 Gateway 所在的命名空间（此处为 default）
  parentRefs:
    - name: envoy-gateway
      namespace: envoy-gateway-system # 必须与 Gateway 的命名空间一致
  hostnames:
    - "backend-demo-router.demo" # 需确保客户端能解析该域名到 Gateway 的外部 IP
  rules:
    # 关键修正：合并权重规则到同一条 rule 中
    - matches:
        - path:
            type: PathPrefix
            value: / # 匹配所有路径
          headers:
            - name: version
              value: "v1"
      backendRefs:
        # 权重配置：v1 占 2/3 流量，v2 占 1/3 流量
        - group: ""
          kind: Service
          name: backend-demo-v1
          port: 8000 # 填写 Service 的 ClusterIP 端口（而非 NodePort）
          weight: 2
    - matches:
        - path:
            type: PathPrefix
            value: / # 匹配所有路径
          headers:
            - name: version
              value: "v2"
      backendRefs:
        - group: ""
          kind: Service
          name: backend-demo-v2
          port: 8000
          weight: 1